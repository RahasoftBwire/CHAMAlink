{% extends "base.html" %}
{% block title %}Founder Dashboard - Bwire Finance Cloud{% endblock %}

<!-- Add CSRF token -->
<meta name="csrf-token" content="{{ csrf_token() }}">

{% block content %}
<div class="founder-dashboard">
    <!-- Welcome Header -->
    <div class="container-fluid py-4">
        <div class="welcome-header mb-4">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="h3 mb-2">
                        <i class="fas fa-crown text-warning me-2"></i>
                        Welcome, <span class="text-warning">Founder Bilford</span>! üëë
                    </h1>
                    <p class="text-muted mb-0">Your Bwire Finance Cloud empire overview and management console</p>
                </div>
                <div class="col-md-4 text-md-end">
                    <div class="d-flex flex-column flex-md-row gap-2">
                        <button class="btn btn-warning" onclick="newFeatureAction()">
                            <i class="fas fa-plus me-2"></i>New Feature
                        </button>
                        <a href="{{ url_for('main.test_email') }}" class="btn btn-info">
                            <i class="fas fa-envelope me-2"></i>Test Email
                        </a>
                        <button class="btn btn-outline-secondary" onclick="exportChamas()">
                            <i class="fas fa-download me-2"></i>Export Data
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Founder Stats -->
        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="founder-stat-card bg-primary">
                    <div class="stat-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="stat-content">
                        <h3 class="stat-number">{{ "{:,}".format(admin_users or 0) }}</h3>
                        <p class="stat-label">Admin Users</p>
                        <small class="stat-change">
                            <i class="fas fa-crown"></i> System administrators
                        </small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="founder-stat-card bg-success">
                    <div class="stat-icon">
                        <i class="fas fa-building"></i>
                    </div>
                    <div class="stat-content">
                        <h3 class="stat-number">{{ "{:,}".format(total_chamas or 0) }}</h3>
                        <p class="stat-label">Total Chamas</p>
                        <small class="stat-change">
                            <i class="fas fa-check-circle"></i> {{ active_chamas }} active
                        </small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="founder-stat-card bg-warning">
                    <div class="stat-icon">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <div class="stat-content">
                        <h3 class="stat-number">KES {{ "{:,.0f}".format(total_revenue or 0) }}</h3>
                        <p class="stat-label">Total Revenue</p>
                        <small class="stat-change">
                            <i class="fas fa-chart-line"></i> Platform revenue
                        </small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="founder-stat-card bg-info">
                    <div class="stat-icon">
                        <i class="fas fa-heart"></i>
                    </div>
                    <div class="stat-content">
                        <h3 class="stat-number">{{ "{:.1f}".format(active_chama_percentage or 0) }}%</h3>
                        <p class="stat-label">Chama Health</p>
                        <small class="stat-change">
                            <i class="fas fa-smile"></i> Active communities
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Dashboard Content -->
        <div class="row g-4">
            <!-- Left Column -->
            <div class="col-lg-8">
                <!-- Chama Management -->
                <div class="card founder-card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-shield-alt me-2"></i>Chama Oversight
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="alert alert-warning">
                                    <strong>{{ pending_chamas|length }}</strong> Pending Review
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="alert alert-danger">
                                    <strong>{{ flagged_chamas|length }}</strong> Flagged
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="alert alert-success">
                                    <strong>{{ active_chamas }}</strong> Active & Healthy
                                </div>
                            </div>
                        </div>

                        <!-- Flagged Chamas -->
                        {% if flagged_chamas %}
                        <h6 class="text-danger mb-3">‚ö†Ô∏è Chamas Requiring Attention</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Chama Name</th>
                                        <th>Members</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for chama in flagged_chamas %}
                                    <tr>
                                        <td>{{ chama.name }}</td>
                                        <td>{{ chama.member_count }}</td>
                                        <td><span class="badge bg-danger">{{ chama.status.title() }}</span></td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <button class="btn btn-sm btn-success" onclick="toggleChamaStatus({{ chama.id }}, 'activate')" title="Restore chama">
                                                    <i class="fas fa-check"></i> Restore
                                                </button>
                                                <button class="btn btn-sm btn-warning" onclick="toggleChamaStatus({{ chama.id }}, 'suspend')" title="Suspend chama">
                                                    <i class="fas fa-pause"></i> Suspend
                                                </button>
                                                <button class="btn btn-sm btn-danger" onclick="toggleChamaStatus({{ chama.id }}, 'blacklist')" title="Blacklist chama">
                                                    <i class="fas fa-ban"></i> Blacklist
                                                </button>
                                                <button class="btn btn-sm btn-dark" onclick="toggleChamaStatus({{ chama.id }}, 'delete')" title="Delete chama permanently">
                                                    <i class="fas fa-trash"></i> Delete
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Recent Payments -->
                <div class="card founder-card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-credit-card me-2"></i>Recent Subscription Payments
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="payment-list">
                            {% for payment in recent_payments[:10] %}
                            <div class="payment-item">
                                <div class="payment-info">
                                    <h6 class="payment-user">{{ payment.user.username }}</h6>
                                    <p class="payment-desc">{{ payment.subscription.plan.name }} Plan</p>
                                </div>
                                <div class="payment-amount text-success">
                                    KES {{ "{:,.0f}".format(payment.amount) }}
                                </div>
                                <div class="payment-time">
                                    {{ payment.payment_date.strftime('%b %d, %Y') if payment.payment_date else 'Unknown' }}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="col-lg-4">
                <!-- User Statistics -->
                <div class="card founder-card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-users me-2"></i>User Statistics
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6">
                                <h3 class="text-primary">{{ total_users or 0 }}</h3>
                                <p class="mb-0">Total Users</p>
                            </div>
                            <div class="col-6">
                                <h3 class="text-success">{{ verified_users or 0 }}</h3>
                                <p class="mb-0">Verified Users</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Notepad -->
                <div class="card founder-card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-sticky-note me-2"></i>Quick Notes
                        </h5>
                        <div class="card-actions">
                            <button class="btn btn-sm btn-outline-primary" onclick="saveNote()">
                                <i class="fas fa-save me-1"></i>Save
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="clearNote()">
                                <i class="fas fa-trash me-1"></i>Clear
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="notepad-container">
                            <textarea id="founderNotepad" 
                                      class="form-control notepad-textarea" 
                                      rows="8" 
                                      placeholder="üí° Jot down quick notes, ideas, reminders...
üìã Action items and todos
üìû Important contacts
üéØ Business insights
üí∞ Revenue opportunities

Auto-saves every 30 seconds..."></textarea>
                            <div class="notepad-footer mt-2">
                                <small class="text-muted">
                                    <span id="notepadStatus">
                                        <i class="fas fa-circle text-success"></i> Ready
                                    </span>
                                    <span class="float-end">
                                        <span id="charCount">0</span> characters
                                    </span>
                                </small>
                            </div>
                        </div>
                        
                        <!-- Quick Note Templates -->
                        <div class="mt-3">
                            <small class="text-muted mb-2 d-block">Quick Templates:</small>
                            <div class="d-flex flex-wrap gap-1">
                                <button class="btn btn-outline-secondary btn-sm" onclick="insertTemplate('meeting')">
                                    üìÖ Meeting Notes
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="insertTemplate('todo')">
                                    ‚úÖ Todo List
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="insertTemplate('ideas')">
                                    üí° Ideas
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- All Chamas List -->
                <div class="card founder-card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-university me-2"></i>All Chamas ({{ all_chamas|length }})
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if all_chamas %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Chama Name</th>
                                        <th>Creator</th>
                                        <th>Members</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for chama in all_chamas %}
                                    <tr>
                                        <td>
                                            <strong>{{ chama.name }}</strong>
                                            {% if chama.description %}
                                            <br><small class="text-muted">{{ chama.description[:50] }}...</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if chama.creator %}
                                            {{ chama.creator.username }}
                                            {% else %}
                                            <span class="text-muted">Unknown</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-info">{{ chama.member_count or 0 }}</span>
                                        </td>
                                        <td>
                                            {% if chama.status == 'active' %}
                                                <span class="badge bg-success">Active</span>
                                            {% elif chama.status == 'pending' %}
                                                <span class="badge bg-warning">Pending</span>
                                            {% elif chama.status == 'flagged' %}
                                                <span class="badge bg-danger">Flagged</span>
                                            {% else %}
                                                <span class="badge bg-secondary">{{ chama.status.title() if chama.status else 'Unknown' }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small>{{ chama.created_at.strftime('%b %d, %Y') if chama.created_at else 'Unknown' }}</small>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <a href="{{ url_for('chama.chama_detail', chama_id=chama.id) }}" 
                                                   class="btn btn-outline-primary" title="View Details">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                
                                                <!-- Dropdown for more actions -->
                                                <div class="btn-group" role="group">
                                                    <button type="button" class="btn btn-outline-secondary dropdown-toggle" 
                                                            data-bs-toggle="dropdown" aria-expanded="false" title="Actions">
                                                        <i class="fas fa-cog"></i>
                                                    </button>
                                                    <ul class="dropdown-menu">
                                                        {% if chama.status == 'pending' %}
                                                        <li><a class="dropdown-item" href="#" onclick="toggleChamaStatus({{ chama.id }}, 'activate')">
                                                            <i class="fas fa-check text-success me-2"></i>Approve
                                                        </a></li>
                                                        {% endif %}
                                                        
                                                        {% if chama.status == 'active' %}
                                                        <li><a class="dropdown-item" href="#" onclick="toggleChamaStatus({{ chama.id }}, 'suspend')">
                                                            <i class="fas fa-pause text-warning me-2"></i>Suspend
                                                        </a></li>
                                                        {% endif %}
                                                        
                                                        {% if chama.status in ['suspended', 'pending'] %}
                                                        <li><a class="dropdown-item" href="#" onclick="toggleChamaStatus({{ chama.id }}, 'activate')">
                                                            <i class="fas fa-play text-success me-2"></i>Activate
                                                        </a></li>
                                                        {% endif %}
                                                        
                                                        {% if chama.status != 'flagged' %}
                                                        <li><a class="dropdown-item" href="#" onclick="toggleChamaStatus({{ chama.id }}, 'flag')">
                                                            <i class="fas fa-flag text-warning me-2"></i>Flag
                                                        </a></li>
                                                        {% endif %}
                                                        
                                                        <li><a class="dropdown-item" href="#" onclick="toggleChamaStatus({{ chama.id }}, 'blacklist')">
                                                            <i class="fas fa-ban text-danger me-2"></i>Blacklist
                                                        </a></li>
                                                        
                                                        <li><hr class="dropdown-divider"></li>
                                                        <li><a class="dropdown-item text-danger" href="#" onclick="toggleChamaStatus({{ chama.id }}, 'delete')">
                                                            <i class="fas fa-trash me-2"></i>Delete Permanently
                                                        </a></li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-university fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No chamas found</h5>
                            <p class="text-muted">No chamas have been created yet.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card founder-card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-lightning-bolt me-2"></i>Founder Actions
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-warning" onclick="sendPlatformNotice()">
                                <i class="fas fa-bell me-2"></i>Send Platform Notice
                            </button>
                            <button class="btn btn-info" onclick="generatePlatformReport()">
                                <i class="fas fa-chart-bar me-2"></i>Generate Report
                            </button>
                            <button class="btn btn-success" onclick="createPromotion()">
                                <i class="fas fa-gift me-2"></i>Create Promotion
                            </button>
                            <button class="btn btn-danger" onclick="emergencyActions()">
                                <i class="fas fa-exclamation-triangle me-2"></i>Emergency Actions
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for Founder Actions -->
<script>
function toggleChamaStatus(chamaId, action) {
    const actionMessages = {
        'activate': 'activate',
        'suspend': 'suspend', 
        'blacklist': 'blacklist',
        'delete': 'delete',
        'flag': 'flag'
    };
    
    const actionMsg = actionMessages[action] || action;
    if (!confirm(`Are you sure you want to ${actionMsg} this chama?`)) {
        return;
    }

    // Get CSRF token
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    fetch(`/founder-dashboard/chama/${chamaId}/toggle-status`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ 
            action: action,
            csrf_token: csrfToken
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred');
    });
}

function exportChamas() {
    // Show loading state
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Exporting...';
    button.disabled = true;
    
    // Redirect to export endpoint
    window.location.href = '{{ url_for("main.export_all_chamas") }}';
    
    // Reset button after a delay
    setTimeout(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    }, 3000);
}

// New Feature Action
function newFeatureAction() {
    const modal = `
        <div class="modal fade" id="newFeatureModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">üöÄ Add New Feature</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="newFeatureForm">
                            <div class="mb-3">
                                <label class="form-label">Feature Name</label>
                                <input type="text" class="form-control" id="featureName" placeholder="e.g., Advanced Analytics">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" id="featureDescription" rows="3" placeholder="Describe the new feature..."></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Priority</label>
                                <select class="form-control" id="featurePriority">
                                    <option value="low">Low</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="high">High</option>
                                    <option value="critical">Critical</option>
                                </select>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-warning" onclick="submitNewFeature()">Add Feature</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modal);
    const modalInstance = new bootstrap.Modal(document.getElementById('newFeatureModal'));
    modalInstance.show();
    
    // Remove modal from DOM when closed
    document.getElementById('newFeatureModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

function submitNewFeature() {
    const name = document.getElementById('featureName').value;
    const description = document.getElementById('featureDescription').value;
    const priority = document.getElementById('featurePriority').value;
    
    if (!name || !description) {
        alert('Please fill in all required fields');
        return;
    }
    
    // Send to backend
    fetch('/founder-dashboard/new-feature', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            name: name,
            description: description,
            priority: priority
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`‚úÖ ${data.message}`);
            bootstrap.Modal.getInstance(document.getElementById('newFeatureModal')).hide();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while adding the feature');
    });
}

// Send Platform Notice
function sendPlatformNotice() {
    const modal = `
        <div class="modal fade" id="platformNoticeModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">üì¢ Send Platform Notice</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="noticeForm">
                            <div class="mb-3">
                                <label class="form-label">Notice Title</label>
                                <input type="text" class="form-control" id="noticeTitle" placeholder="e.g., System Maintenance Notice">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Message</label>
                                <textarea class="form-control" id="noticeMessage" rows="4" placeholder="Enter your platform-wide message..."></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Priority Level</label>
                                <select class="form-control" id="noticePriority">
                                    <option value="info">Info</option>
                                    <option value="warning">Warning</option>
                                    <option value="urgent">Urgent</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="sendEmail" checked>
                                    <label class="form-check-label" for="sendEmail">
                                        Send email notification to all admins
                                    </label>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-warning" onclick="submitPlatformNotice()">Send Notice</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modal);
    const modalInstance = new bootstrap.Modal(document.getElementById('platformNoticeModal'));
    modalInstance.show();
    
    document.getElementById('platformNoticeModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

function submitPlatformNotice() {
    const title = document.getElementById('noticeTitle').value;
    const message = document.getElementById('noticeMessage').value;
    const priority = document.getElementById('noticePriority').value;
    const sendEmail = document.getElementById('sendEmail').checked;
    
    if (!title || !message) {
        alert('Please fill in all required fields');
        return;
    }
    
    // Send to backend
    fetch('/founder-dashboard/platform-notice', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            title: title,
            message: message,
            priority: priority,
            send_email: sendEmail
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`üì¢ ${data.message}`);
            bootstrap.Modal.getInstance(document.getElementById('platformNoticeModal')).hide();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while sending the notice');
    });
}

// Generate Platform Report
function generatePlatformReport() {
    const reportOptions = [
        'User Activity Report',
        'Financial Summary Report',
        'Chama Performance Report',
        'System Health Report',
        'Security Audit Report'
    ];
    
    const modal = `
        <div class="modal fade" id="reportModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">üìä Generate Platform Report</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Report Type</label>
                            <select class="form-control" id="reportType">
                                ${reportOptions.map(option => `<option value="${option}">${option}</option>`).join('')}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Date Range</label>
                            <select class="form-control" id="dateRange">
                                <option value="7">Last 7 days</option>
                                <option value="30" selected>Last 30 days</option>
                                <option value="90">Last 90 days</option>
                                <option value="365">Last year</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Export Format</label>
                            <select class="form-control" id="exportFormat">
                                <option value="pdf">PDF</option>
                                <option value="excel">Excel</option>
                                <option value="csv">CSV</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-info" onclick="generateReport()">Generate Report</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modal);
    const modalInstance = new bootstrap.Modal(document.getElementById('reportModal'));
    modalInstance.show();
    
    document.getElementById('reportModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

function generateReport() {
    const reportType = document.getElementById('reportType').value;
    const dateRange = document.getElementById('dateRange').value;
    const exportFormat = document.getElementById('exportFormat').value;
    
    // Send to backend
    fetch('/founder-dashboard/generate-report', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            report_type: reportType,
            date_range: dateRange,
            export_format: exportFormat
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`üìä ${data.message}`);
            bootstrap.Modal.getInstance(document.getElementById('reportModal')).hide();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while generating the report');
    });
}

// Create Promotion
function createPromotion() {
    const modal = `
        <div class="modal fade" id="promotionModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">üéÅ Create Promotion</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="promotionForm">
                            <div class="mb-3">
                                <label class="form-label">Promotion Name</label>
                                <input type="text" class="form-control" id="promoName" placeholder="e.g., Holiday Special">
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Discount Type</label>
                                        <select class="form-control" id="discountType">
                                            <option value="percentage">Percentage Off</option>
                                            <option value="fixed">Fixed Amount Off</option>
                                            <option value="free_trial">Extended Free Trial</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Discount Value</label>
                                        <input type="number" class="form-control" id="discountValue" placeholder="e.g., 20">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Start Date</label>
                                        <input type="date" class="form-control" id="startDate">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">End Date</label>
                                        <input type="date" class="form-control" id="endDate">
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-success" onclick="submitPromotion()">Create Promotion</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modal);
    const modalInstance = new bootstrap.Modal(document.getElementById('promotionModal'));
    modalInstance.show();
    
    document.getElementById('promotionModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

function submitPromotion() {
    const name = document.getElementById('promoName').value;
    const discountType = document.getElementById('discountType').value;
    const discountValue = document.getElementById('discountValue').value;
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    if (!name || !discountValue || !startDate || !endDate) {
        alert('Please fill in all required fields');
        return;
    }
    
    // Send to backend
    fetch('/founder-dashboard/create-promotion', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            name: name,
            discount_type: discountType,
            discount_value: discountValue,
            start_date: startDate,
            end_date: endDate
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`üéÅ ${data.message}`);
            bootstrap.Modal.getInstance(document.getElementById('promotionModal')).hide();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while creating the promotion');
    });
}

// Emergency Actions
function emergencyActions() {
    const modal = `
        <div class="modal fade" id="emergencyModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content border-danger">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title">‚ö†Ô∏è Emergency Actions</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-warning">
                            <strong>Warning:</strong> These actions affect the entire platform. Use with extreme caution!
                        </div>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-warning" onclick="maintenanceMode()">
                                üîß Enable Maintenance Mode
                            </button>
                            <button class="btn btn-outline-info" onclick="broadcastMessage()">
                                üì¢ Emergency Broadcast
                            </button>
                            <button class="btn btn-outline-danger" onclick="freezeAllTransactions()">
                                üõë Freeze All Transactions
                            </button>
                            <button class="btn btn-outline-dark" onclick="generateBackup()">
                                üíæ Generate System Backup
                            </button>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modal);
    const modalInstance = new bootstrap.Modal(document.getElementById('emergencyModal'));
    modalInstance.show();
    
    document.getElementById('emergencyModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

function maintenanceMode() {
    if (confirm('Enable maintenance mode? This will make the platform inaccessible to users.')) {
        const message = prompt('Enter maintenance message (optional):', 'System under maintenance. We\'ll be back shortly!');
        
        fetch('/founder-dashboard/maintenance-mode', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                enable: true,
                message: message || 'System under maintenance'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`üîß ${data.message}`);
                bootstrap.Modal.getInstance(document.getElementById('emergencyModal')).hide();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while enabling maintenance mode');
        });
    }
}

function broadcastMessage() {
    const message = prompt('Enter emergency broadcast message:');
    if (message) {
        const sendSMS = confirm('Also send via SMS? (if configured)');
        
        fetch('/founder-dashboard/emergency-broadcast', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: message,
                send_sms: sendSMS,
                send_email: true
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`üì¢ ${data.message}`);
                bootstrap.Modal.getInstance(document.getElementById('emergencyModal')).hide();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while sending emergency broadcast');
        });
    }
}

function freezeAllTransactions() {
    if (confirm('Freeze all financial transactions? This is a critical action!')) {
        alert('üõë All transactions have been frozen. Contact users immediately.');
        bootstrap.Modal.getInstance(document.getElementById('emergencyModal')).hide();
    }
}

function generateBackup() {
    alert('üíæ System backup initiated. You will receive confirmation when complete.');
    bootstrap.Modal.getInstance(document.getElementById('emergencyModal')).hide();
}

// Notepad functionality
const notepad = document.getElementById('founderNotepad');
const charCount = document.getElementById('charCount');
const notepadStatus = document.getElementById('notepadStatus');

// Load saved note on page load
window.addEventListener('load', () => {
    const savedNote = localStorage.getItem('founderNote');
    if (savedNote) {
        notepad.value = savedNote;
        charCount.innerText = savedNote.length;
    }
});

// Auto-save note every 30 seconds
setInterval(() => {
    if (notepad.value) {
        localStorage.setItem('founderNote', notepad.value);
        notepadStatus.innerHTML = '<i class="fas fa-circle text-success"></i> Auto-saved';
    }
}, 30000);

// Update character count
notepad.addEventListener('input', () => {
    charCount.innerText = notepad.value.length;
});

function saveNote() {
    if (notepad.value) {
        localStorage.setItem('founderNote', notepad.value);
        alert('üìù Note saved successfully!');
    } else {
        alert('Nothing to save!');
    }
}

function clearNote() {
    if (confirm('Clear all notes? This action cannot be undone.')) {
        notepad.value = '';
        localStorage.removeItem('founderNote');
        charCount.innerText = '0';
        notepadStatus.innerHTML = '<i class="fas fa-circle text-warning"></i> Cleared';
    }
}

function insertTemplate(type) {
    let template = '';
    
    switch(type) {
        case 'meeting':
            template = `
                ### Meeting Notes
                
                **Date:** 
                **Time:** 
                **Attendees:** 
                
                **Agenda:** 
                
                **Notes:** 
                
                **Action Items:** 
            `;
            break;
        case 'todo':
            template = `
                ### Todo List
                
                - [ ] 
                - [ ] 
                - [ ] 
            `;
            break;
        case 'ideas':
            template = `
                ### Ideas
                
                - 
// Notepad Functionality
let autoSaveTimer;
const AUTOSAVE_DELAY = 30000; // 30 seconds

document.addEventListener('DOMContentLoaded', function() {
    const notepad = document.getElementById('founderNotepad');
    const charCount = document.getElementById('charCount');
    const status = document.getElementById('notepadStatus');
    
    if (!notepad) return;
    
    // Load saved notes
    loadNote();
    
    // Character counter
    notepad.addEventListener('input', function() {
        const count = this.value.length;
        charCount.textContent = count;
        
        // Update status to show unsaved changes
        updateStatus('unsaved', 'Unsaved changes...');
        
        // Reset auto-save timer
        clearTimeout(autoSaveTimer);
        autoSaveTimer = setTimeout(autoSaveNote, AUTOSAVE_DELAY);
    });
    
    // Initial character count
    charCount.textContent = notepad.value.length;
});

function loadNote() {
    const savedNote = localStorage.getItem('founderNotepadContent');
    if (savedNote) {
        document.getElementById('founderNotepad').value = savedNote;
        document.getElementById('charCount').textContent = savedNote.length;
    }
}

function saveNote() {
    const notepad = document.getElementById('founderNotepad');
    const content = notepad.value;
    
    // Save to localStorage
    localStorage.setItem('founderNotepadContent', content);
    localStorage.setItem('founderNotepadLastSaved', new Date().toISOString());
    
    updateStatus('saved', 'Saved successfully!');
    
    // Optional: Save to server
    saveNoteToServer(content);
}

function autoSaveNote() {
    const notepad = document.getElementById('founderNotepad');
    const content = notepad.value;
    
    if (content.trim()) {
        localStorage.setItem('founderNotepadContent', content);
        localStorage.setItem('founderNotepadLastSaved', new Date().toISOString());
        updateStatus('autosaved', 'Auto-saved');
    }
}

function clearNote() {
    if (confirm('Are you sure you want to clear all notes? This cannot be undone.')) {
        document.getElementById('founderNotepad').value = '';
        document.getElementById('charCount').textContent = '0';
        localStorage.removeItem('founderNotepadContent');
        updateStatus('cleared', 'Notes cleared');
    }
}

function updateStatus(type, message) {
    const status = document.getElementById('notepadStatus');
    const icons = {
        saved: 'fas fa-check text-success',
        autosaved: 'fas fa-clock text-info',
        unsaved: 'fas fa-circle text-warning',
        cleared: 'fas fa-trash text-danger',
        ready: 'fas fa-circle text-success'
    };
    
    status.innerHTML = `<i class="${icons[type] || icons.ready}"></i> ${message}`;
    
    // Reset to ready after 3 seconds
    if (type !== 'unsaved') {
        setTimeout(() => {
            status.innerHTML = '<i class="fas fa-circle text-success"></i> Ready';
        }, 3000);
    }
}

function insertTemplate(type) {
    const notepad = document.getElementById('founderNotepad');
    const charCount = document.getElementById('charCount');
    
    const templates = {
        meeting: `
üìÖ Meeting Notes - ${new Date().toLocaleDateString()}
========================
üìã Agenda:
- 
- 
- 

üí¨ Key Discussions:
- 
- 

‚úÖ Decisions Made:
- 
- 

üéØ Action Items:
- [ ] 
- [ ] 

üìä Metrics Discussed:
- 
- 

`,
        todo: `
‚úÖ Todo List - ${new Date().toLocaleDateString()}
==================
üî• High Priority:
- [ ] 
- [ ] 

üìã Medium Priority:
- [ ] 
- [ ] 

üìù Notes:
- [ ] 
- [ ] 

`,
        ideas: `
üí° Ideas & Insights - ${new Date().toLocaleDateString()}
==========================
üöÄ New Features:
- 
- 

üí∞ Revenue Opportunities:
- 
- 

üîß Improvements:
- 
- 

üìà Business Strategy:
- 
- 

`
    };
    
    const template = templates[type] || '';
    const currentValue = notepad.value;
    const newValue = currentValue + (currentValue ? '\n\n' : '') + template;
    
    notepad.value = newValue;
    charCount.textContent = newValue.length;
    notepad.focus();
    
    // Trigger save
    updateStatus('unsaved', 'Unsaved changes...');
    clearTimeout(autoSaveTimer);
    autoSaveTimer = setTimeout(autoSaveNote, AUTOSAVE_DELAY);
}

function saveNoteToServer(content) {
    // Optional: Send to server endpoint
    fetch('/founder-dashboard/save-note', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
        },
        body: JSON.stringify({ content: content })
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            console.warn('Failed to save note to server:', data.message);
        }
    })
    .catch(error => {
        console.warn('Error saving note to server:', error);
    });
}
</script>

<style>
.founder-dashboard {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    min-height: 100vh;
}

.founder-stat-card {
    background: linear-gradient(135deg, var(--bs-primary), var(--bs-primary));
    color: white;
    border-radius: 15px;
    padding: 1.5rem;
    position: relative;
    overflow: hidden;
    transition: transform 0.3s ease;
}

.founder-stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

.founder-stat-card.bg-primary {
    background: linear-gradient(135deg, #1e3a8a, #1e40af);
}

.founder-stat-card.bg-success {
    background: linear-gradient(135deg, #28a745, #20c997);
}

.founder-stat-card.bg-warning {
    background: linear-gradient(135deg, #ffc107, #fd7e14);
    color: #333;
}

.founder-stat-card.bg-info {
    background: linear-gradient(135deg, #17a2b8, #6f42c1);
}

.founder-stat-card .stat-icon {
    position: absolute;
    top: 1rem;
    right: 1rem;
    font-size: 2rem;
    opacity: 0.3;
}

.founder-stat-card .stat-number {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.founder-stat-card .stat-label {
    font-size: 1rem;
    margin-bottom: 0.5rem;
    opacity: 0.9;
}

.founder-stat-card .stat-change {
    font-size: 0.85rem;
    opacity: 0.8;
}

.founder-card {
    border: none;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    transition: transform 0.3s ease;
}

.founder-card:hover {
    transform: translateY(-2px);
}

.founder-card .card-header {
    background: linear-gradient(135deg, #1e3a8a, #1e40af);
    color: white;
    border-radius: 15px 15px 0 0;
    border: none;
}

.payment-item {
    display: flex;
    align-items: center;
    padding: 1rem 0;
    border-bottom: 1px solid #e9ecef;
}

.payment-item:last-child {
    border-bottom: none;
}

.payment-info {
    flex: 1;
}

.payment-user {
    font-size: 0.9rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.payment-desc {
    font-size: 0.8rem;
    color: #6c757d;
    margin-bottom: 0;
}

.payment-amount {
    font-weight: 600;
    margin-right: 1rem;
}

.payment-time {
    font-size: 0.75rem;
    color: #6c757d;
    white-space: nowrap;
}

.user-item {
    display: flex;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid #e9ecef;
}

.user-item:last-child {
    border-bottom: none;
}

.user-avatar {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #1e3a8a, #1e40af);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 0.75rem;
}

.user-info {
    flex: 1;
}

.user-name {
    font-size: 0.9rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.user-email {
    font-size: 0.75rem;
    color: #6c757d;
}

.user-status {
    font-size: 1.2rem;
}

/* Notepad Styles */
.notepad-container {
    position: relative;
}

.notepad-textarea {
    resize: vertical;
    min-height: 200px;
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    font-size: 0.9rem;
    line-height: 1.5;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 12px;
    background: #fafafa;
    transition: all 0.3s ease;
}

.notepad-textarea:focus {
    background: #fff;
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    outline: none;
}

.notepad-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.8rem;
}

.card-actions {
    display: flex;
    gap: 0.5rem;
}

.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.8rem;
}

/* Template buttons */
.btn-outline-secondary.btn-sm {
    font-size: 0.75rem;
    padding: 0.2rem 0.5rem;
    border-radius: 15px;
    white-space: nowrap;
}

.btn-outline-secondary.btn-sm:hover {
    background-color: #6c757d;
    border-color: #6c757d;
    color: #fff;
}

/* Status indicators */
#notepadStatus i.text-success {
    color: #28a745 !important;
}

#notepadStatus i.text-warning {
    color: #ffc107 !important;
}

#notepadStatus i.text-info {
    color: #17a2b8 !important;
}

#notepadStatus i.text-danger {
    color: #dc3545 !important;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .notepad-textarea {
        min-height: 150px;
        font-size: 0.85rem;
    }
    
    .card-actions {
        flex-direction: column;
        gap: 0.25rem;
    }
    
    .btn-outline-secondary.btn-sm {
        margin-bottom: 0.25rem;
    }
}
</style>
{% endblock %}

